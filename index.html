<!DOCTYPE html>
<html lang="pt-br">
<head>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gr√°fico de Sujeira</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="auth.css">
  <style>
    /* Estilos para a statistics-view */
    #statistics-view .sides {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }
    #statistics-view .valvulas-list {
        display: grid;
        /* Altera para 2 fileiras de 6 */
        grid-template-columns: repeat(6, 1fr);
        gap: 15px;
        margin-top: 20px;
        padding: 0 1rem;
        /* Centraliza o grid */
        justify-items: center;
    }
    /* Media query para telas menores, para quebrar a linha */
    @media (max-width: 768px) {
        #statistics-view .valvulas-list {
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Ajusta para telas menores */
        }
    }

    #statistics-view .valvula-item {
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        transition: background-color 0.3s ease;
        width: 100%; /* Garante que o item ocupe a largura da coluna */
        max-width: 150px; /* Limita a largura individual do item */
    }
    #statistics-view .valvula-item:hover {
        background-color: #e0e0e0;
    }
    #statistics-view .valvula-item.selected {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }



    #statistics-view h2 {
        text-align: center;
        margin-top: 20px;
        color: #333;
    }
    #statistics-view .top-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 1rem;
        background-color: #eee;
        border-bottom: 1px solid #ccc;
        flex-wrap: wrap; /* Permite quebrar linha em telas pequenas */
        gap: 10px; /* Espa√ßamento entre os itens da top bar */
    }
    #statistics-view .top-bar button,
    #statistics-view .top-bar select {
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    #statistics-view .top-bar button:hover,
    #statistics-view .top-bar select:hover {
        background-color: #0056b3;
    }
    #statistics-view .side-btn {
        background-color: #e9ecef;
        color: #495057;
        border: 1px solid #ced4da;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    #statistics-view .side-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    #graph-view .top-bar { /* Garante que o bot√£o da estat√≠stica apare√ßa corretamente aqui */
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    /* Novos estilos para os bot√µes de √°rea */
    .area-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 15px;
    }
    .area-button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #6ddc36; /* Cor para Raizer/Caixa */
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .area-button:hover {
        background-color: #292a29;
    }
    .area-button.active {
        background-color: #000000;
        border: 2px solid #1c1d1c;
    }

    /* Estilo para ocultar o gr√°fico de barras inicialmente */
    #bar-chart-container {
        display: none;
    }
    /* Estilo para o novo bot√£o Ver Imagem da √Årea */
    #goToImagePageButton {
        padding: 10px 20px;
        background-color: #28a745; /* Verde escuro */
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        margin-top: 20px; /* Adicionado margem para separa√ß√£o */
    }
    #goToImagePageButton:hover {
        background-color: #218838;
    }
    /* Estilo para o t√≠tulo de display de √°rea e lado */
    #currentAreaSideDisplay {
        margin-top: 15px;
        color: #555;
    }
       /* Estilos para o cont√™iner do gr√°fico de barras */
#bar-chart-container {
        display: none; /* Mant√©m oculto inicialmente */
        width: 90%; /* Ajuste a largura conforme desejar */
        max-width: 900px; /* Limite m√°ximo de largura */
        margin: 20px auto; /* Centraliza */
        padding: 20px;
        background-color: #ffffff67;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        /* *************** ADI√á√ÉO IMPORTANTE AQUI *************** */
        height: 550px; /* Altere esta linha */
        /* OU, se preferir uma altura m√°xima: */
        /* max-height: 600px; */
}

    /* Estilos para o pr√≥prio canvas do gr√°fico */
    #grafico-valvulas {
        width: 100% !important; /* Garante que o canvas ocupe a largura total do cont√™iner */
        height: 100% !important; /* Garante que o canvas ocupe a altura total do cont√™iner */
        /* O !important √© usado para tentar sobrescrever estilos de bibliotecas, se necess√°rio */
    }
     #search-graph-view .search-filters {
        display: flex;
        flex-wrap: wrap; /* Permite que os itens quebrem a linha */
        gap: 15px; /* Espa√ßamento entre os itens */
        justify-content: center;
        margin-top: 20px;
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    #search-graph-view .search-filters label {
        font-weight: bold;
        color: #555;
        flex-basis: 100%; /* Faz a label ocupar a linha inteira em telas pequenas */
        text-align: center;
    }
    @media (min-width: 600px) { /* Em telas maiores, labels e inputs podem ficar lado a lado */
        #search-graph-view .search-filters label {
            flex-basis: auto;
            text-align: left;
        }
    }

    #search-graph-view .search-filters input[type="date"],
    #search-graph-view .search-filters input[type="text"],
    #search-graph-view .search-filters select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 1em;
        flex-grow: 1; /* Permite que os inputs e selects cres√ßam */
        min-width: 150px; /* Largura m√≠nima para inputs */
    }

    #search-graph-view .search-filters button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
        font-size: 1em;
        transition: background-color 0.3s ease;
    }
    #search-graph-view .search-filters button:hover {
        background-color: #0056b3;
    }
    /* Layout responsivo para a grade de v√°lvulas */
.container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 2rem 2.5rem;
  justify-items: center;
  align-items: start;
  margin-bottom: 2rem;
  max-width: 270px;
  max-height: 450px;
  margin-left: auto;
  margin-right: auto;
}

/* FOR√áA 3 COLUNAS EM TELAS PEQUENAS */
@media (max-width: 600px) {
  .container {
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    padding: 0 10px;
  }

  .valvula-wrapper {
    width: 100%;
    max-width: 120px;
  }
}
.area-buttons,
.sides {
  justify-content: center;
  flex-wrap: wrap;
  gap: 10px;
  display: flex;
  margin-bottom: 1rem;
}

@media (max-width: 600px) {
  .sides {
    padding: 0 10px;
  }
}



    
  </style>
</head>
<body>

  <div id="login-view" class="view active">
    <form class="auth-form" id="login-form">
      <h2>Login</h2>
      <input type="email" id="login-username" placeholder="E-mail" required>
      <input type="password" id="login-password" placeholder="Senha" required>
      <button type="submit">Entrar</button>
      <div class="switch">
        N√£o tem conta? <a href="#" id="to-register">Cadastre-se</a>
      </div>
      <button type="button" id="btn-google">Login com Google</button>
    </form>
  </div>

  <div id="register-view" class="view">
    <form class="auth-form" id="register-form">
      <h2>Cadastro</h2>
      <input type="text" id="reg-nome" placeholder="Nome" required>
      <input type="email" id="reg-username" placeholder="E-mail" required>
      <input type="password" id="reg-password" placeholder="Senha" required>
      <button type="submit">Cadastrar</button>
      <div class="switch">
        J√° tem conta? <a href="#" id="to-login">Fa√ßa login</a>
      </div>
      <button type="button" id="btn-google-register">Cadastrar com Google</button>
    </form>
  </div>

  <div id="valve-view" class="view">
    <header class="valve-header">


      <div id="user-display" class="user-info"></div>
    </header>

    

  <div id="inputs-pressao">
      
  <div class="input-group">

    <input type="hidden" id="input-usuario" placeholder="Seu Nome" readonly>
  </div>
  <div class="input-group">
   
    <input type="hidden" id="input-area" placeholder="Raizer" readonly>
  </div>

</div>
    <div class="area-buttons">
        <button class="area-button" data-area="Caixa">Ir para Caixa</button>
        <button class="area-button" data-area="Raizer">Ir para Raiser</button>
    </div>

    <div class="sides">
      <strong>Lado:</strong>
      <button class="side-btn" data-side="A">A</button>
      <button class="side-btn" data-side="B">B</button>
      <button class="side-btn" data-side="C">C</button>
      <button class="side-btn" data-side="D">D</button>
    </div>

   
    <h2 id="side-title" class="clickable-title"></h2> <div class="image-area">
    <img id="area-image" src="" alt="">

    <div class="container" id="valvulas-container">
      </div>

    <div id="pergunta-global-container" class="pergunta-global-container">
      </div>

    <div id="confirmar-container">
        <button id="btn-Graphics" onclick="showGraphOptions()">Ver Gr√°ficos</button>
      <button id="btn-show-pressure-input">Press√µes</button>
      <button id="btn-sair" onclick="logout()">Sair</button>
      <button id="btn-confirmar">Salvar</button>
    </div>

    <div id="modal-perfil" class="modal">
      <div class="modal-content">
        <h3>Complete seu perfil</h3>
        <input type="text" id="perfil-nome" placeholder="Nome Completo" required>
        <input type="password" id="perfil-senha" placeholder="Criar Senha (opcional)">
        <button id="btn-salvar-perfil">Salvar Perfil</button>
      </div>
    </div>

    <div id="modal-reset" class="modal">
      <div class="modal-content">
        <h3>Tem certeza que deseja resetar as notas deste lado?</h3>
        <div>
          <button id="btn-sim-resetar">Sim</button>
          <button id="btn-nao-resetar">N√£o</button>
        </div>
      </div>
    </div>

    <div id="modal-confirmacao-geral" class="modal">
      <div class="modal-content">
        <h3>Confirmar registro dos Graus?</h3>
        <div>
          <button id="btn-sim-confirmar">Sim</button>
          <button id="btn-nao-confirmar">N√£o</button>
        </div>
      </div>
    </div>

    <div id="modal-confirmacao" class="modal">
      <div class="modal-content">
        <h3>Limpeza Conclu√≠da!</h3>
        <pre id="resumo-text-modal" class="resumo-text"></pre>
        <button id="btn-fechar-modal">Fechar</button>
        <button id="btn-download-modal">Baixar Resumo</button>
      </div>
    </div>
  </div>
</div>
<div id="graph-view" class="view">
    <h1>Op√ß√µes de Gr√°fico</h1>

    <div class="top-bar">
      <button onclick="showBarChart()">EM MANUNTEN√á√ÉO(BARRAS)</button>
      <button onclick="showSearchGraphView()">EM MANUNTEN√á√ÉO(PESQUISAR)</button>

      <button onclick="showView('statistics-view'); initStatisticsView();">Ver Estat√≠sticas de V√°lvulas</button>
      <button onclick="showView('valve-view')">üîô Voltar para v√°lvulas</button>
    </div>

    <div id="bar-chart-container">
        <h2>Gr√°fico de Sujeira por Lado</h2>
        <div class="top-bar">
            <button class="side-btn-graph" data-side-graph="A">Lado A</button>
            <button class="side-btn-graph" data-side-graph="B">Lado B</button>
            <button class="side-btn-graph" data-side-graph="C">Lado C</button>
            <button class="side-btn-graph" data-side-graph="D">Lado D</button>
            <select id="periodo-select">
                <option value="7">√öltimos 7 dias</option>
                <option value="30">√öltimos 30 dias</option>
            </select>
            <button onclick="baixarGrafico()">‚¨áÔ∏è Baixar Gr√°fico</button>
        </div>
        <canvas id="grafico-valvulas"></canvas>
    </div>
  </div>

  <div id="statistics-view" class="view">
    <div class="top-bar">
      

        <button onclick="showView('valve-view')">üîô Voltar para v√°lvulas</button>
        <h2>Estat√≠sticas de V√°lvulas</h2>
        <select id="statistics-periodo-select"> <option value="7">√öltimos 7 dias</option>
            <option value="30">√öltimos 30 dias</option>
            <option value="all">Todo Per√≠odo</option> </select>
        <button onclick="baixarStatisticsGrafico()">‚¨áÔ∏è Baixar Gr√°fico</button>
    </div>

    <div class="area-buttons">
        <button class="area-button" data-area="Raizer">Raiser</button>
        <button class="area-button" data-area="Caixa">Caixa</button>
    </div>

    <div class="sides">
        <strong>Lado:</strong>
        <button class="side-btn" data-side="A">A</button>
        <button class="side-btn" data-side="B">B</button>
        <button class="side-btn" data-side="C">C</button>
        <button class="side-btn" data-side="D">D</button>
    </div>

    <h2 id="statistics-side-title">Selecione uma V√°lvula do Lado A</h2>

    <div class="valvulas-list" id="valvulas-statistics-container">
        </div>

    <div class="chart-container">
        <canvas id="grafico-sujeira-valvula"></canvas>
    </div>
  </div>

<div id="search-graph-view" class="view">
    <h1>Pesquisar Gr√°ficos Detalhados</h1>

    <div class="top-bar">
        <button onclick="showView('graph-view')">üîô Voltar para Op√ß√µes de Gr√°fico</button>
    </div>

    <div class="search-filters">
        <label for="search-start-date">Data Inicial:</label>
        <input type="date" id="search-start-date">

        <label for="search-end-date">Data Final:</label>
        <input type="date" id="search-end-date">

       <label for="search-valve">V√°lvula:</label>
       <select id="search-valve">
       <option value="">Todas as V√°lvulas</option> </select>

        <label for="search-side">Lado:</label>
        <select id="search-side">
            <option value="A">Lado A</option>
            <option value="B">Lado B</option>
            <option value="C">Lado C</option>
            <option value="D">Lado D</option>
            <option value="all">Todos os Lados</option>
        </select>

        <label for="search-area">√Årea:</label>
        <select id="search-area">
            <option value="Raizer">Raiser</option>
            <option value="Caixa">Caixa</option>
            <option value="all">Todas as √Åreas</option>
        </select>

        <label for="search-chart-type">Tipo de Gr√°fico:</label>
        <select id="search-chart-type">
         <option value="line">Linha</option>
         <option value="bar">Barras</option>
        </select>

        <button onclick="performGraphSearch()">Gerar Gr√°fico</button>
        <button onclick="downloadSearchGraph()">‚¨áÔ∏è Baixar Gr√°fico</button>
    </div>




</div>

<div id="pressure-input-view" class="view">
    <button class="back-button" onclick="showView('valve-view')">Voltar</button>
    <h2>Entrada de Press√£o</h2>
    <div id="inputs-pressao">
      <label for="inputRaizer">Press√£o Raizer:</label>
      <input type="number" id="inputRaizer" placeholder="Ex: 50" step="0.01">

      <label for="inputCaixa">Press√£o Caixa:</label>
      <input type="number" id="inputCaixa" placeholder="Ex: 50" step="0.01">
    </div>
</div>

<div id="resumo-imagem-container" style="position: absolute; left: -9999px; top: -9999px;"></div>
</div>



  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="auth.js"></script>
  <script src="script.js"></script>
  <script src="statistics.js"></script> 
  <script>
    // Configura√ß√£o do Firebase (SEU C√ìDIGO ORIGINAL - MANTIDO)
    const firebaseConfig = {
      apiKey: "AIzaSyAJ1_vq5j-Aa6JOXEvUYMxr10lTuCfdTMQ",
      authDomain: "valvulas-ed105.firebaseapp.com",
      projectId: "valvulas-ed105",
      storageBucket: "valvulas-ed105.appspot.com",
      messagingSenderId: "152027783297",
      appId: "1:152027783297:web:474885a8874c0184202d80"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("iniciado")

    // Vari√°veis e fun√ß√µes relacionadas ao Chart.js (Gr√°fico de Barras)
    let ladoAtualGrafico = 'A';
    let areaAtualGrafico = 'Raizer'; // √Årea padr√£o
    // Certifique-se de que o ID do seu canvas √© 'grafico-valvulas'
    const ctx = document.getElementById('grafico-valvulas').getContext('2d');
    let grafico = null;
      // Vari√°vel para a inst√¢ncia do gr√°fico de pesquisa
    let searchChart = null;

    function formatarData(iso) {
      const d = new Date(iso);
      const dia = String(d.getDate()).padStart(2, '0');
      const mes = String(d.getMonth() + 1).padStart(2, '0');
      const ano = d.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

async function gerarGrafico() {
    const dias = parseInt(document.getElementById('periodo-select').value);
    const agora = new Date();
    const limite = new Date(agora.getTime() - dias * 86400000);
    limite.setHours(0, 0, 0, 0);
    const limiteISO = limite.toISOString();

    const snapshot = await db.collection('registros')
        .where('data', '>=', limiteISO)
        .where('lado', '==', ladoAtualGrafico)
        .where('area', '==', areaAtualGrafico)
        .get();

    const ocorrenciasPorValvula = {}; // Vai armazenar um Set de datas para evitar duplica√ß√£o di√°ria
    snapshot.forEach(doc => {
        const valvulas = doc.data().valvulas || {};
        const dataRegistro = formatarData(doc.data().data); // Ex: "10/07/2025"
        for (const [nome, nota] of Object.entries(valvulas)) {
            const n = parseInt(nota);
            if (n >= 4) {
                if (!ocorrenciasPorValvula[nome]) {
                    ocorrenciasPorValvula[nome] = new Set(); // Usa um Set para armazenar datas √∫nicas
                }
                ocorrenciasPorValvula[nome].add(dataRegistro); // Adiciona a data formatada ao Set
            }
        }
    });

    const labels = Object.keys(ocorrenciasPorValvula).sort();
    // Agora, os dados s√£o o tamanho do Set, ou seja, quantas datas diferentes a v√°lvula apareceu com nota >= 4
    const dados = labels.map(label => ocorrenciasPorValvula[label].size);

    // Para os tooltips, voc√™ ainda pode querer listar todas as datas.
    // Isso exigiria uma pequena adapta√ß√£o se voc√™ quiser os detalhes originais
    // de nota e dia de cada ocorr√™ncia, mesmo que conte apenas uma por dia no gr√°fico.
    // Por simplicidade, vamos adaptar o tooltip para apenas listar as datas √∫nicas.
    const tooltips = labels.map(label => {
        const datasUnicas = Array.from(ocorrenciasPorValvula[label]).sort();
        return `Ocorr√™ncias em: ${datasUnicas.join(", ")}`;
    });


    if (grafico) grafico.destroy();

    grafico = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels.length ? labels : ['Nenhum dado'],
            datasets: [{
                label: `Ocorr√™ncias de Sujeira (Notas 4 ou 5) - ${areaAtualGrafico} - Lado ${ladoAtualGrafico}`,
                data: labels.length ? dados : [0],
                backgroundColor: '#ff4d4d'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const idx = context.dataIndex;
                            return tooltips[idx] || 'Sem detalhes';
                        }
                    },
                    bodyFont: { size: 14 },
                    footerFont: { size: 14 },
                    titleFont: { size: 14 }
                },
                title: {
                    display: true,
                    text: `V√°lvulas Sujas (notas 4 ou 5) - ${areaAtualGrafico} - Lado ${ladoAtualGrafico} (${dias} dias)`,
                    font: { size: 18 }
                },
                legend: { display: false }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'V√°lvula',
                        font: { size: 16 }
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Dias com Ocorr√™ncia', // T√≠tulo ajustado
                        font: { size: 16 }
                    },
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1 // Garante que o eixo Y mostre n√∫meros inteiros
                    }
                }
            }
        }
    });
}

    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de lado (visualiza√ß√£o de v√°lvulas)
    function updateActiveSideButtonValveView() {
      document.querySelectorAll('#valve-view .sides .side-btn').forEach(btn => {
        if (btn.dataset.side === currentSide) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de √°rea (visualiza√ß√£o de v√°lvulas)
    function updateActiveAreaButtonValveView() {
      document.querySelectorAll('#valve-view .area-button').forEach(btn => {
        if (btn.dataset.area === currentArea) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
      // Atualiza o campo de input da √°rea
      document.getElementById('input-area').value = currentArea;
    }


    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de lado (visualiza√ß√£o de gr√°fico de barras)
    function updateActiveSideButtonGraphView() {
      document.querySelectorAll('#graph-view .top-bar .side-btn-graph').forEach(btn => {
        if (btn.dataset.sideGraph === ladoAtualGrafico) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });
    }

    // Fun√ß√£o para gerenciar o estado ativo dos bot√µes de √°rea para o gr√°fico de barras
    // (Voc√™ n√£o tem bot√µes de √°rea expl√≠citos na graph-view para o gr√°fico de barras no HTML,
    // mas se adicionar no futuro, esta fun√ß√£o seria adaptada aqui)
    function updateActiveAreaButtonGraphViewForBarChart() {
        // Exemplo: se houver bot√µes como <button data-area-graph="Raizer">
        // document.querySelectorAll('#graph-view .area-button-graph').forEach(btn => {
        //     if (btn.dataset.areaGraph === areaAtualGrafico) {
        //         btn.classList.add('active');
        //     } else {
        //         btn.classList.remove('active');
        //     }
        // });
    }

    // RENOMEADA E AJUSTADA: Fun√ß√£o para selecionar o lado no gr√°fico de barras e gerar o gr√°fico
    function selecionarLadoGrafico(lado) { // Note: 'selecionar' com 's', n√£o 'seleccionar'
      ladoAtualGrafico = lado;
      updateActiveSideButtonGraphView(); // Atualiza a classe ativa para os bot√µes de lado do gr√°fico
      gerarGrafico();
    }

    // FUN√á√ÉO ADICIONADA: Para selecionar a √°rea no gr√°fico de barras e gerar o gr√°fico
    function selecionarAreaGrafico(area) {
        areaAtualGrafico = area;
        updateActiveAreaButtonGraphViewForBarChart(); // Se tiver bot√µes de √°rea para o gr√°fico
        gerarGrafico();
    }


    function baixarGrafico() {
      const link = document.createElement('a');
      link.download = `grafico_valvulas_barras_${areaAtualGrafico}_${ladoAtualGrafico}.png`;
      link.href = document.getElementById('grafico-valvulas').toDataURL('image/png');
      link.click();
    }

    function baixarStatisticsGrafico() {
      const link = document.createElement('a');
      link.download = `grafico_estatisticas_${currentStatisticsArea}_${currentStatisticsSide}_${currentSelectedValve}.png`;
      link.href = document.getElementById('grafico-sujeira-valvula').toDataURL('image/png');
      link.click();
    }

    // FUN√á√ÉO AJUSTADA: showGraphOptions agora vai para a view do gr√°fico
    function showGraphOptions() {
        showView('graph-view');
        // Voc√™ pode decidir se quer mostrar um gr√°fico padr√£o ao entrar na showGraphOptions
        // ou esperar o usu√°rio clicar em "Ver Gr√°fico em Barra".
        // O c√≥digo abaixo esconde inicialmente e aguarda o clique no bot√£o "Ver Gr√°fico em Barra".
        document.getElementById('bar-chart-container').style.display = 'none'; // Esconde o gr√°fico de barras inicialmente
    }

    // FUN√á√ÉO AJUSTADA: showBarChart agora exibe o cont√™iner e carrega o gr√°fico
    function showBarChart() {
        document.getElementById('bar-chart-container').style.display = 'block'; // Mostra o cont√™iner do gr√°fico
        // Assume que voc√™ quer carregar o Lado A da √°rea atual (Raizer por padr√£o)
        selecionarLadoGrafico('A'); // Carrega o gr√°fico do Lado A por padr√£o
    }


    // Adiciona listener para os bot√µes de lado da visualiza√ß√£o de v√°lvulas (EXISTENTE)
    document.querySelectorAll('#valve-view .sides .side-btn').forEach(btn => {
      btn.onclick = () => {
        currentSide = btn.dataset.side;
        initValves();
        updateActiveSideButtonValveView();
      };
    });

    // Adiciona listener para os bot√µes de √°rea da visualiza√ß√£o de v√°lvulas (EXISTENTE)
    document.querySelectorAll('#valve-view .area-button').forEach(btn => {
        btn.onclick = () => {
            currentArea = btn.dataset.area;
            initValves(); // Re-inicializa as v√°lvulas para a nova √°rea
            updateActiveAreaButtonValveView();
        };
    });


    // Inicializa a visualiza√ß√£o do gr√°fico quando o app carrega, se o usu√°rio j√° estiver logado
    firebase.auth().onAuthStateChanged(user => {
        if (user) {
            startApp(); // De script.js, mostra valve-view
            updateActiveSideButtonValveView();
            updateActiveAreaButtonValveView();
            // N√ÉO CHAMA showBarChart aqui, pois showBarChart deve ser acionada pelo bot√£o
        } else {
            showView('login-view');
        }
    });

    // Listener para o dropdown de per√≠odo do gr√°fico de barras (EXISTENTE)
    document.getElementById('periodo-select').addEventListener('change', gerarGrafico);

    // Adiciona listeners para os bot√µes de lado do gr√°fico de barras (EXISTENTE)
    document.querySelectorAll('#graph-view .side-btn-graph').forEach(btn => {
        btn.addEventListener('click', () => {
            selecionarLadoGrafico(btn.dataset.sideGraph);
        });
    });

    // Seus listeners para os bot√µes de √°rea do gr√°fico de barras (ADICIONE SE TIVER NO FUTURO)
    // Exemplo:
    // document.querySelectorAll('#graph-view .area-button-graph').forEach(btn => {
    //     btn.addEventListener('click', () => {
    //         selecionarAreaGrafico(btn.dataset.areaGraph);
    //     });
    // });


    // NOVO C√ìDIGO JAVASCRIPT: Bot√£o "Ver Imagem da √Årea" e T√≠tulo de Display (SEU C√ìDIGO ORIGINAL - MANTIDO)

    // currentAreaSideDisplay n√£o est√° declarado no seu script, ent√£o o c√≥digo abaixo pode dar erro.
    // Se quiser um t√≠tulo din√¢mico, voc√™ precisaria adicionar um elemento HTML com esse ID.
    // const currentAreaSideDisplay = document.getElementById('currentAreaSideDisplay');



    function showSearchGraphView() {
        showView('search-graph-view');
        // Opcional: Definir datas padr√£o ou limpar campos ao entrar na view
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('search-end-date').value = today;
        // Data inicial: 30 dias atr√°s como padr√£o
        const thirtyDaysAgo = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
        document.getElementById('search-start-date').value = thirtyDaysAgo;

        // Limpa o gr√°fico anterior se houver
        if (searchChart) {
            searchChart.destroy();
            searchChart = null; // Reseta a inst√¢ncia
        }
        // Limpa o canvas para que n√£o apare√ßa o gr√°fico anterior enquanto n√£o √© gerado um novo
        document.getElementById('search-chart-canvas').getContext('2d').clearRect(0, 0, document.getElementById('search-chart-canvas').width, document.getElementById('search-chart-canvas').height);
    }

    // Fun√ß√£o principal para realizar a pesquisa e gerar o gr√°fico
async function performGraphSearch() {
  const startDate = document.getElementById('search-start-date').value;
  const endDate   = document.getElementById('search-end-date').value;
  const valveName = document.getElementById('search-valve').value.trim();
  const sideFilter = document.getElementById('search-side').value;
  const areaFilter = document.getElementById('search-area').value;
  const chartType = document.getElementById('search-chart-type').value;

  const canvas = document.getElementById('search-chart-canvas');
  const ctx = canvas.getContext('2d');

  // Valida√ß√£o b√°sica
  if (!startDate || !endDate) {
    alert('Selecione as datas inicial e final para a pesquisa.');
    return;
  }
  if (new Date(startDate) > new Date(endDate)) {
    alert('A data inicial n√£o pode ser posterior √† data final.');
    return;
  }

  // ISO para Firestore
  const isoStart = new Date(new Date(startDate).setHours(0, 0, 0, 0)).toISOString();
  const isoEnd   = new Date(new Date(endDate).setHours(23, 59, 59, 999)).toISOString();

  // Monta a query
  let query = db.collection('registros')
    .where('data', '>=', isoStart)
    .where('data', '<=', isoEnd);

  if (sideFilter !== 'all') query = query.where('lado', '==', sideFilter);
  if (areaFilter !== 'all') query = query.where('area', '==', areaFilter);

  const snapshot = await query.get();
  const countsByValveAndDate = {};

  snapshot.forEach(doc => {
    const data = doc.data();
    const dataFormatada = formatarData(data.data); // DD/MM/YYYY
    const valvulas = data.valvulas || {};

    for (const [nome, notaStr] of Object.entries(valvulas)) {
      const nota = parseInt(notaStr);
      if (valveName && nome !== valveName) continue;

      if (!countsByValveAndDate[nome]) countsByValveAndDate[nome] = {};
      countsByValveAndDate[nome][dataFormatada] = nota; // salva nota (1 a 5)
    }
  });

  if (searchChart) searchChart.destroy();

  if (Object.keys(countsByValveAndDate).length === 0) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.font = "18px Arial";
    ctx.textAlign = "center";
    ctx.fillStyle = "#666";
    ctx.fillText("Nenhum dado encontrado", canvas.width / 2, canvas.height / 2);
    return;
  }

  // Todas as datas envolvidas
  const allDates = new Set();
  Object.values(countsByValveAndDate).forEach(d => Object.keys(d).forEach(date => allDates.add(date)));

  const sortedDates = Array.from(allDates).sort((a, b) => {
    const [da, ma, aa] = a.split('/');
    const [db, mb, ab] = b.split('/');
    return new Date(`${aa}-${ma}-${da}`) - new Date(`${ab}-${mb}-${db}`);
  });

  if (chartType === 'line') {
    const datasets = Object.entries(countsByValveAndDate).map(([nome, dateMap]) => ({
      label: nome,
      data: sortedDates.map(d => dateMap[d] ?? null),
      fill: true,
      tension: 0.3,
      borderColor: getRandomColor(),
      backgroundColor: 'rgba(0, 123, 255, 0.1)',
      pointRadius: 4,
      pointHoverRadius: 6
    }));

    searchChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: sortedDates,
        datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            min: 0,
            max: 5,
            title: {
              display: true,
              text: 'Nota (1‚Äì5)'
            },
            ticks: {
              stepSize: 1
            }
          },
          x: {
            title: {
              display: true,
              text: 'Data'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: `Evolu√ß√£o da Sujeira: ${valveName || 'Todas'}`
          },
          tooltip: {
            callbacks: {
              label: ctx => `Nota: ${ctx.raw}`
            }
          }
        }
      }
    });

  } else {
    // Gr√°fico de barra: soma quantas vezes a v√°lvula teve nota ‚â• 4
    const somaPorValve = {};
    Object.entries(countsByValveAndDate).forEach(([nome, datas]) => {
      const total = Object.values(datas).filter(n => n >= 4).length;
      somaPorValve[nome] = total;
    });

    const nomes = Object.keys(somaPorValve).sort();
    const dados = nomes.map(n => somaPorValve[n]);

    searchChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: nomes,
        datasets: [{
          label: 'Ocorr√™ncias de Sujeira (Nota ‚â•4)',
          data: dados,
          backgroundColor: 'rgba(255, 99, 132, 0.7)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Ocorr√™ncias'
            },
            ticks: { stepSize: 1 }
          },
          x: {
            title: {
              display: true,
              text: 'V√°lvula'
            }
          }
        },
        plugins: {
          title: {
            display: true,
            text: `Ocorr√™ncias no per√≠odo: ${startDate} a ${endDate}`
          }
        }
      }
    });
  }
}




    // Fun√ß√£o para gerar cores aleat√≥rias para gr√°ficos de linha (para diferenciar as v√°lvulas)
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }

    function downloadSearchGraph() {
        const link = document.createElement('a');
        link.download = `grafico_pesquisa_${document.getElementById('search-chart-type').value}.png`;
        link.href = document.getElementById('search-chart-canvas').toDataURL('image/png');
        link.click();
    }


  </script>
</body>
</html>